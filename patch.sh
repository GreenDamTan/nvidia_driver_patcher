#!/bin/bash

#BASEDIR=$(dirname $0)
#VER_TARGET=560.94
#DriverDir=${VER_TARGET}-desktop-win10-win11-64bit-international-dch-whql
#DisplayDriverDir=${BASEDIR}/${DriverDir}/Display.Driver
#displaydriverDir=${BASEDIR}/${DriverDir}/display.driver
#
#curl \
#"https://cn.download.nvidia.com/Windows/${VER_TARGET}/${DriverDir}.exe" \
#-o ${DriverDir}.exe
#[ -e "${DriverDir}.exe" ] || echo "nvidia windows driver installer not found"
#md5sum ${DriverDir}.exe
#
#which 7z &>/dev/null || echo "have not install p7zip-full for 7z tool (http://p7zip.sourceforge.net/)"
#which msexpand &>/dev/null || echo "have not install mscompress (https://github.com/stapelberg/mscompress)"
#
#echo "extracting the driver installer, please wait..."
#7z x -o${DriverDir} "${DriverDir}.exe" > unzip.log

LANG=C
AllList=`find -iname '*.sys' -o -iname '*.dll'`
#printf "ALLList:\n"
#for item in $AllList; do
#  echo "${item}"
#done
ModList=("")
printf "start grep:\n"
for i in $AllList
do
  grep -obUaP "\x07\x1C\x07\x00\x09\x1C\x07\x00" ${i}
  [ ${?} -eq 0 ] && ModList+=("${i}") && echo ${i} #|| printf "not grep:${i}\n"
done
printf "ModList:\n"
printf '%s\n' "${ModList[@]}"

for i in ${ModList[@]}
do {
  echo "remove signature: ${i}"
  osslsigncode remove-signature -in ${i} -out ${i}-unsigned || echo "osslsigncode remove-signature failed"
  echo "hexdump: ${i}-unsigned"
  hexdump -ve '1/1 "%.2X"' ${i}-unsigned > ${i}.hex
  rm -f ${i}
  sed -e 's/2A1C0000821D0000C21D0000/CC1C0000CC1D0000CC1D0000/g' \
      -e 's/031E0000061E0000101E00002D1E0000/CC1E0000CC1E0000CC1E0000CC1E0000/g' \
      -e 's/421E0000431E0000441E0000471E0000/CC1E0000CC1E0000CC1E0000CC1E0000/g' \
      -e 's/501E00006D1E0000801E0000/CC1E0000CC1E0000CC1E0000/g' \
      -e 's/AB1E0000AC1E0000EB1E0000EC1E0000/CC1E0000CC1E0000CC1E0000CC1E0000/g' \
      -e 's/F01E0000F11E0000F61E0000F81E0000F91E0000FA1E0000FB1E0000/CC1E0000CC1E0000CC1E0000CC1E0000CC1E0000CC1E0000CC1E0000/g' \
      -e 's/011F0000041F0000051F0000091F00000C1F0000131F0000/CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000/g' \
      -e 's/411F0000431F0000441F0000451F0000461F0000481F0000491F00004C1F0000/CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000/g' \
      -e 's/531F0000801F0000811F0000931F00009E1F0000/CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000/g' \
      -e 's/C11F0000C21F0000C31F0000/CC1F0000CC1F0000CC1F0000/g' \
      -e 's/D11F0000D21F0000D31F0000D71F0000D81F0000DC1F0000DE1F0000/CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000CC1F0000/g' \
      -e 's/F81F0000FB1F0000FC1F0000/CC1F0000CC1F0000CC1F0000/g' \
      -e 's/80200000BE200000BF200000C0200000FE200000FF200000/CC200000CC200000CC200000CC200000CC200000CC200000/g' \
      -e 's/802100008321000085210000AE210000AF210000C2210000C3210000C5210000C7210000/cc210000cc210000cc210000cc210000cc210000cc210000cc210000cc210000cc210000/g' \
      -e 's/052200000922000014220000172200002B2200003C220000/cc220000cc220000cc220000cc220000cc220000cc220000/g' \
      -e 's/43220000442200004622000048220000492200004A220000/cc220000cc220000cc220000cc220000cc220000cc220000/g' \
      -e 's/5422000056220000572200006B220000702200007122000094220000/cc220000cc220000cc220000cc220000cc220000cc220000cc220000/g' \
      -e 's/B0230000BE230000F0230000/cc230000cc230000cc230000/g' \
      -e 's/022400000424000042240000442400005424000078240000/cc240000cc240000cc240000cc240000cc240000cc240000/g' \
      -e 's/80240000852400008C2400008D2400008E2400009E2400009F240000/cc240000cc240000cc240000cc240000cc240000cc240000cc240000/g' \
      -e 's/A4240000AC240000AD240000BE240000C0240000/cc240000cc240000cc240000cc240000cc240000/g' \
      -e 's/C2240000C4240000C5240000C6240000C8240000CD240000CE240000/cc240000cc240000cc240000cc240000cc240000cc240000cc240000/g' \
      -e 's/DE240000DF240000E4240000EC240000ED240000F0240000F1240000F6240000F7240000F8240000/cc240000cc240000cc240000cc240000cc240000cc240000cc240000cc240000cc240000cc240000/g' \
      -e 's/0025000001250000052500000925000040250000412500004325000045250000482500004925000061250000802500008125000083250000/0025000001250000052500000925000040250000412500004325000045250000482500004925000061250000802500008125000083250000/g' \
      -e 's/A3250000A4250000C1250000C2250000C3250000C4250000E3250000E4250000EB250000F8250000/A3250000A4250000C1250000C2250000C3250000C4250000E3250000E4250000EB250000F8250000/g' \
      -e 's/812600008226000087260000AF260000B0260000BF260000C1260000C2260000C4260000C7260000/812600008226000087260000AF260000B0260000BF260000C1260000C2260000C4260000C7260000/g' \
      -e 's/F0260000F2260000F3260000F5260000F9260000/F0260000F2260000F3260000F5260000F9260000/g' \
      -e 's/062700002F2700003F2700004427000046270000492700008427000085270000/062700002F2700003F2700004427000046270000492700008427000085270000/g' \
      -e 's/AF270000BF270000C2270000C3270000C4270000C5270000C6270000C8270000F0270000F1270000F2270000F8270000FA270000/AF270000BF270000C2270000C3270000C4270000C5270000C6270000C8270000F0270000F1270000F2270000F8270000FA270000/g' \
      -e 's/02280000072800002F2800003F280000422800004328000045280000472800007828000083280000AF280000BF280000C2280000C3280000E2280000F0280000/02280000072800002F2800003F280000422800004328000045280000472800007828000083280000AF280000BF280000C2280000C3280000E2280000F0280000/g' \
      -e 's/802B0000852B0000872B0000AE2B0000AF2B0000BE2B0000BF2B0000C52B0000C72B0000/802B0000852B0000872B0000AE2B0000AF2B0000BE2B0000BF2B0000C52B0000C72B0000/g' \
      -e 's/002C0000022C0000182C0000192C00002E2C00002F2C0000382C0000392C00003E2C00003F2C0000582C0000592C0000782C0000792C0000802C0000AF2C0000BF2C0000/002C0000022C0000182C0000192C00002E2C00002F2C0000382C0000392C00003E2C00003F2C0000582C0000592C0000782C0000792C0000802C0000AF2C0000BF2C0000/g' \
      -e 's/002D0000182D0000192D00002F2D0000392D00003F2D0000582D0000592D0000792D0000802D0000982D0000AF2D0000B82D0000B92D0000BF2D0000D82D0000F82D0000F92D0000/002D0000182D0000192D00002F2D0000392D00003F2D0000582D0000592D0000792D0000802D0000982D0000AF2D0000B82D0000B92D0000BF2D0000D82D0000F82D0000F92D0000/g' \
      -e 's/002E0000002F0000042F0000182F00002E2F00002F2F0000382F00003F2F0000442F0000582F0000782F0000/002E0000002F0000042F0000182F00002E2F00002F2F0000382F00003F2F0000442F0000582F0000782F0000/g' \
      -e 's/C2150700071B0700871B0700C71B0700/C2150700071B0700871B0700C71B0700/g' \
      -e 's/071C0700091C0700831D0700841D0700C11D0700/071C0700091C0700831D0700841D0700C11D0700/g' \
      -e 's/091E0700491E0700BC1E0700FC1E07000B1F0700/091E0700491E0700BC1E0700FC1E07000B1F0700/g' \
      -e 's/812007008220070083200700C2200700/812007008220070083200700C2200700/g' \
      -e 's/892107000D2207004D2207008A240700CA2407000A250700/892107000D2207004D2207008A240700CA2407000A250700/g' \
      -i ${i}.hex
  xxd -r -p ${i}.hex ${i}
  rm -f ${i}.hex
  echo "sign signature: ${i}"
#  osslsigncode sign -pkcs12 tools/cert.pfx -pass "GreenDamTan" -n "nikki" \
#               -t http://timestamp.digicert.com -in ${i}-unsigned -out ${i}
#  rm -f ${i}-unsigned
  jsign --keystore tools/cert.pfx --storetype PKCS12 --storepass GreenDamTan \
        --tsaurl http://timestamp.digicert.com ${i}
  }&
done
wait

#mv ${DisplayDriverDir} ${displaydriverDir}
#for i in $( find ${displaydriverDir} -maxdepth 1 -name "*[A-Z]*" ); do mv -if "$i" "`echo $i | tr 'A-Z' 'a-z'`"; done
#for i in $( find ${displaydriverDir} -maxdepth 2 -name "*[A-Z]*" ); do mv -if "$i" "`echo $i | tr 'A-Z' 'a-z'`"; done
#for i in $( find ${displaydriverDir} -maxdepth 3 -name "*[A-Z]*" ); do mv -if "$i" "`echo $i | tr 'A-Z' 'a-z'`"; done
#for i in $( find ${displaydriverDir} -maxdepth 4 -name "*[A-Z]*" ); do mv -if "$i" "`echo $i | tr 'A-Z' 'a-z'`"; done
##tree .
##ls -l ${displaydriverDir}/
##echo ${displaydriverDir}
##pwd
#dotnet ${BASEDIR}/tools/inf2cat/Inf2Cat.exe /driver:"${displaydriverDir}" /os:10_x64 /verbose
#mv ${displaydriverDir} ${DisplayDriverDir}
##osslsigncode sign -pkcs12 tools/cert.pfx -pass "GreenDamTan" \
##    -n "nikki" -t http://timestamp.digicert.com \
##    -jp low \
##    -in ${DisplayDriverDir}/nv_disp.cat \
##    -out ${DisplayDriverDir}/nv_disp.cat
##mkdir ~/.wine
##chown -R $USER: ~/.wine
##winetricks -q mfc42
##sudo wine ${BASEDIR}/tools/signtool/signtool.exe sign /f tools/cert.pfx \
##        /p GreenDamTan /a /fd sha256 \
##        /t http://timestamp.digicert.com \
##        ${DisplayDriverDir}/nv_disp.cat
# jsign --keystore tools/cert.pfx --storetype PKCS12 --storepass GreenDamTan \
#       --tsaurl http://timestamp.digicert.com ${DisplayDriverDir}/nv_disp.cat